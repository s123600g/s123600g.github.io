<!DOCTYPE html>
<html>







<head>
  <meta charset="utf-8">
  <title>
    JYU Blog - 使用EdgeTpu應用在語音模型預測之簡單實例(四)-模型轉換格式為tflite
  </title>
  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa"
    crossorigin="anonymous"></script>

  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>

  <!-- 針對是否為Production Mode對應特定Js套件來源引入 -->
  <!-- 

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.29/vue.global.prod.min.js"
    integrity="sha512-NZwTAzVi1EAKCNv0XBX0j3+4UyjSlMjYSrfZw9l8Vi+oSCMUWhnadIBcqbODVuird9fAsl5fx6ysQT2lGxsQjw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

   -->

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/MainStyles.css" />
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/pace-theme-default.min.css">
</head>







<body>
  






<div class="container">
    <header
        class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">

        <div class="col-md-3 text-start fs-3">
            JYU Blog
        </div>

        <ul class="nav nav-pills col-12 col-md-auto mb-2 fs-5 justify-content-center mb-md-0">
            <li class="nav-item">
                <a class="nav-link text-body" href="/" class="nav-link px-2 link-secondary">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-body" href="/about" class="nav-link px-2 link-secondary">About</a>
            </li>
        </ul>

        <div class="col-md-3 text-end">
        </div>

    </header>
</div>
  






<main class="container-sm">
    <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
        aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><i class="fas fa-home"></i> <a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">使用EdgeTpu應用在語音模型預測之簡單實例(四)-模型轉換格式為tflite</li>
        </ol>
    </nav>
    <hr />
</main>

  <main class="container-sm">

    <div class="mb-3">
      <span class="fs-3" style="color: #A6341B;">使用EdgeTpu應用在語音模型預測之簡單實例(四)-模型轉換格式為tflite</span>
      <br />
      <span class="fs-6 opacity-75 text-secondary">
        <i class="fas fa-clock text-info"></i>
        2019-07-20 16:00:00
      </span>
    </div>

    <!--more-->

<p>GitHub：<a href="https://github.com/s123600g/asr_edgetpu_demo">https://github.com/s123600g/asr_edgetpu_demo</a></p>

<p>經過<a href="https://s123600g.github.io/google/edgetpu/2019/07/20/%E4%BD%BF%E7%94%A8EdgeTpu%E6%87%89%E7%94%A8%E5%9C%A8%E8%AA%9E%E9%9F%B3%E6%A8%A1%E5%9E%8B%E9%A0%90%E6%B8%AC%E4%B9%8B%E7%B0%A1%E5%96%AE%E5%AF%A6%E4%BE%8B(%E4%B8%89)-%E5%BB%BA%E7%AB%8B%E6%A8%A1%E5%9E%8B%E8%88%87%E8%A8%93%E7%B7%B4.html">(三) 建立模型與訓練</a>，此階段進行將模型轉換成 tflite 模型，產生可以用在<strong>(五) 使用 edgetpu_compiler 轉換 EdgeTpu 可識別 tflite模型</strong>。</p>

<p>此階段所使用程式為<code class="language-plaintext highlighter-rouge">Model_pb_to_tflite.py</code>。</p>

<p>程式內部一些必要參數配置，存放在<code class="language-plaintext highlighter-rouge">Config.py</code>裡面，如需更改請到<code class="language-plaintext highlighter-rouge">Config.py</code>內找尋對應參數配置進行修改。</p>

<p>轉換之前在專案目錄內<code class="language-plaintext highlighter-rouge">model/model_pb/frozen_model.pb</code>模型大小為415.9kB</p>

<p><img src="edgetpu04-01.png" class="img-fluid rounded mx-auto" /></p>

<p>轉換成tflite模型<code class="language-plaintext highlighter-rouge">tflite_model/ASR_Model.tflite</code>大小為105.2kB</p>

<p><img src="edgetpu04-02.png" class="img-fluid rounded mx-auto" /></p>

<h4 id="執行程式分為兩種方式">執行程式分為兩種方式：</h4>

<p><strong>1. 指定輸入來源位置與輸出位置</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">Model_to_TFLite</span><span class="p">.</span><span class="n">py</span>  <span class="o">--</span><span class="nb">input</span> <span class="n">來源位置</span><span class="o">--</span><span class="n">output</span> <span class="n">輸出位置</span>
</code></pre></div></div>

<p>範例：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">Model_pb_to_tflite</span><span class="p">.</span><span class="n">py</span> \
<span class="o">--</span><span class="nb">input</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jyu</span><span class="o">/</span><span class="n">Program</span><span class="o">/</span><span class="n">Audio_Speech_Recognition_TPU_Demo</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">model_pb</span><span class="o">/</span><span class="n">frozen_model</span><span class="p">.</span><span class="n">pb</span> \
<span class="o">--</span><span class="n">output</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jyu</span><span class="o">/</span><span class="n">Program</span><span class="o">/</span><span class="n">Audio_Speech_Recognition_TPU_Demo</span><span class="o">/</span><span class="n">tflite_model</span><span class="o">/</span><span class="n">ASR_Model</span><span class="p">.</span><span class="n">tflite</span>
</code></pre></div></div>

<p><img src="edgetpu04-03.png" alt="" />
<img src="" class="img-fluid rounded mx-auto" /></p>

<p><img src="edgetpu04-04.png" class="img-fluid rounded mx-auto" /></p>

<p><strong>2. 不指定輸入來源位置與輸出位置，自動抓取 Config.py 內部設置</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">Model_pb_to_tflite</span><span class="p">.</span><span class="n">py</span>
</code></pre></div></div>

<p><img src="edgetpu04-05.png" class="img-fluid rounded mx-auto" /></p>

<script src="https://gist.github.com/s123600g/c9da16cabacc6d88ae1c8a57247d5516.js"></script>

<p><code class="language-plaintext highlighter-rouge">Config.py</code>內部設置如下：</p>

<p>輸入來源位置：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Model_PB_DirectoryName</span> <span class="o">=</span> <span class="s">"model_pb"</span>
<span class="n">Model_PB_Name</span> <span class="o">=</span> <span class="s">"frozen_model.pb"</span>
<span class="n">Model_PB_Path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">Model_DirectoryName</span><span class="p">,</span> <span class="n">Model_PB_DirectoryName</span><span class="p">,</span> <span class="n">Model_PB_Name</span><span class="p">)</span>
</code></pre></div></div>

<p>輸出位置：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Input_Model_Path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">"model"</span><span class="p">)</span>
<span class="n">Output_Model_Name</span> <span class="o">=</span> <span class="s">"ASR_Model.tflite"</span>
<span class="n">Output_Model_Path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">"tflite_model"</span><span class="p">,</span> <span class="n">Output_Model_Name</span><span class="p">)</span>
</code></pre></div></div>
<p><br /></p>

<h4 id="程式執行步驟">程式執行步驟：</h4>

<p><strong>Step 1. 讀取上一階段建立模型與訓練所產生pb模型</strong> <br /></p>

<p>在專案目錄內<code class="language-plaintext highlighter-rouge">model/model_pb/frozen_model.pb</code></p>

<p>須注意！在這裡使用的模型必須經過量化才可進行轉換。</p>

<script src="https://gist.github.com/s123600g/c15f8b55bc33ea6a1ed333b8f7188102.js"></script>

<p><strong>Step 2. 設置權重型態轉換為 uint8，並取得讀取模型輸入層名稱，進行轉換模型為tflite格式模型，並輸出轉換後tflite模型</strong> <br /></p>

<script src="https://gist.github.com/s123600g/7d620b896b1ee1449f2aee3bb6766587.js"></script>

<p><strong>Step 3. 讀取轉換後 tflite 模型進行測試預測</strong> <br /></p>

<p>使用測試資料集為專案目錄內<code class="language-plaintext highlighter-rouge">tflite_model/validdata/down/0a2b400e_nohash_0.txt</code></p>

<p>使用分類標籤資料庫為專案目錄內<code class="language-plaintext highlighter-rouge">DB/class.db3</code></p>

<p>在<code class="language-plaintext highlighter-rouge">Config.py</code>內關於SQLite3配置</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 放置SQLite3 DB檔案目錄名稱
</span><span class="n">SQLite_DB_DirectoryName</span> <span class="o">=</span> <span class="s">"DB"</span> 
<span class="c1"># SQLite3 DB檔案
</span><span class="n">SQLite_name</span> <span class="o">=</span> <span class="s">"class.db3"</span>  
<span class="c1"># SQLite3 資料表名稱
</span><span class="n">db_TableName</span> <span class="o">=</span> <span class="s">'audioclass'</span>  
<span class="c1"># SQLite3 資料表欄位名稱
</span><span class="n">column_ClassNum</span> <span class="o">=</span> <span class="s">'ClassNum'</span> 
<span class="c1"># SQLite3 資料表欄位名稱
</span><span class="n">column_Classname</span> <span class="o">=</span> <span class="s">'ClassName'</span> 
</code></pre></div></div>

<script src="https://gist.github.com/s123600g/b386cb9532d104977b9c4333d25df209.js"></script>

<p>到目前為止針對模型轉換格式為tflite，我們已將pb模型轉換為tflite模型，接下來就可以進行<a href="https://s123600g.github.io/google/edgetpu/2019/07/20/%E4%BD%BF%E7%94%A8EdgeTpu%E6%87%89%E7%94%A8%E5%9C%A8%E8%AA%9E%E9%9F%B3%E6%A8%A1%E5%9E%8B%E9%A0%90%E6%B8%AC%E4%B9%8B%E7%B0%A1%E5%96%AE%E5%AF%A6%E4%BE%8B(%E4%BA%94)-%E4%BD%BF%E7%94%A8edgetpu_compiler%E8%BD%89%E6%8F%9BEdgeTpu%E5%8F%AF%E8%AD%98%E5%88%A5tflite%E6%A8%A1%E5%9E%8B.html">(五) 使用 edgetpu_compiler 轉換 EdgeTpu 可識別 tflite模型</a>。</p>

<hr />


    <script src="https://utteranc.es/client.js" repo="s123600g/s123600g.github.io"
      issue-term="title" theme="boxy-light"
      label="Article" crossorigin="anonymous" async></script>
  </main>
</body>

<div class="container">
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
        <div class="col-md-4 d-flex align-items-center">
            <a href="/" class="mb-3 me-2 mb-md-0 text-muted text-decoration-none lh-1">
                <svg class="bi" width="30" height="24">
                    <use xlink:href="#bootstrap"></use>
                </svg>
            </a>
            <span class="text-muted">© 2023 JYUN YU LI. All rights reserved.</span>
        </div>

        <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
            <li class="ms-3">
                <a class="text-muted" href="https://github.com/s123600g" target="_blank">
                    <i class="fab fa-github fs-3"></i>
                </a>
            </li>

            <li class="ms-3">
                <a class="text-muted" href="mailto://s123600g@gmail.com">
                    <i class="fas fa-envelope fs-3"></i>
                </a>
            </li>
        </ul>
    </footer>
</div>

</html>