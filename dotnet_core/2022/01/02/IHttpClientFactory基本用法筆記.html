<!DOCTYPE html>
<html>







<head>
  <meta charset="utf-8">
  <title>
    JYU Blog - IHttpClientFactory基本用法筆記
  </title>
  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa"
    crossorigin="anonymous"></script>

  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>

  <!-- 針對是否為Production Mode對應特定Js套件來源引入 -->
  <!-- 

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.29/vue.global.prod.min.js"
    integrity="sha512-NZwTAzVi1EAKCNv0XBX0j3+4UyjSlMjYSrfZw9l8Vi+oSCMUWhnadIBcqbODVuird9fAsl5fx6ysQT2lGxsQjw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

   -->

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/MainStyles.css" />
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/pace-theme-default.min.css">
</head>







<body>
  






<div class="container">
    <header
        class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">

        <div class="col-md-3 text-start fs-3">
            JYU Blog
        </div>

        <ul class="nav nav-pills col-12 col-md-auto mb-2 fs-5 justify-content-center mb-md-0">
            <li class="nav-item">
                <a class="nav-link text-body" href="/" class="nav-link px-2 link-secondary">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-body" href="/about" class="nav-link px-2 link-secondary">About</a>
            </li>
        </ul>

        <div class="col-md-3 text-end">
        </div>

    </header>
</div>
  






<main class="container-sm">
    <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
        aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><i class="fas fa-home"></i> <a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">IHttpClientFactory基本用法筆記</li>
        </ol>
    </nav>
    <hr />
</main>

  <main class="container-sm">

    <div class="mb-3">
      <span class="fs-3" style="color: #A6341B;">IHttpClientFactory基本用法筆記</span>
      <br />
      <span class="fs-6 opacity-75 text-secondary">
        <i class="fas fa-clock text-info"></i>
        2022-01-02 14:05:00
      </span>
    </div>

    <!--more-->

<p>此筆記為紀錄工作上碰到開發需要，使用<code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>來建立管控<code class="language-plaintext highlighter-rouge">HttpClient</code>生命週期。</p>

<p>依據官方文件(相關參考2)敘述，如果單純使用<code class="language-plaintext highlighter-rouge">HttpClient</code>進行Http請求，一般作法建立<code class="language-plaintext highlighter-rouge">HttpClient</code>新實體，再透過此建立實體來進行Http請求動作。</p>

<p>正常使用完畢後，我們都會認為會自動釋放，因為該類別內部有繼承<code class="language-plaintext highlighter-rouge">IDisposable</code>特性，但是，系統背後通訊端Socket資源佔用問題，卻不會隨著當下實體用完銷毀就跟著被釋放，而後還有其他關於DNS異動調整問題，可以參考相關連結了解詳細。</p>

<p>根據上述狀況，使用官方推薦以<code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>方式來進行<code class="language-plaintext highlighter-rouge">HttpClient</code>管控，在此筆記紀錄基本用法與單一實體在生命週期內重複利用。</p>

<hr />

<h2 id="主要專案">主要專案</h2>
<ol>
  <li>.Net Core 3.1 Console 範例主程式
    <ul>
      <li>以此Console進行呼叫Web API。</li>
    </ul>
  </li>
  <li>Asp.Net 6 範例Web API
    <ul>
      <li>Sample API供應範例Console呼叫。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="範例console主程式">範例Console主程式</h2>

<h3 id="安裝相關nutget套件">安裝相關NutGet套件</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Microsoft.Extensions.DependencyInjection</code></li>
  <li><code class="language-plaintext highlighter-rouge">Microsoft.Extensions.Http</code></li>
</ul>

<h3 id="建立di與註冊ihttpclientfactory">建立DI與註冊IHttpClientFactory</h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ServiceCollection</span> <span class="n">serviceCollection</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ServiceCollection</span><span class="p">();</span>

<span class="n">serviceCollection</span><span class="p">.</span><span class="nf">AddHttpClient</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">serviceBuilder</span> <span class="p">=</span> <span class="n">serviceCollection</span><span class="p">.</span><span class="nf">BuildServiceProvider</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">httpClientFactory</span> <span class="p">=</span> <span class="n">serviceBuilder</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IHttpClientFactory</span><span class="p">&gt;();</span>
</code></pre></div></div>

<h3 id="實作http請求範例內容">實作Http請求範例內容</h3>

<p>依據註入<code class="language-plaintext highlighter-rouge">HttpClientFactory</code>方法<code class="language-plaintext highlighter-rouge">CreateClient</code>搭配<code class="language-plaintext highlighter-rouge">using</code>進行範例實作</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IHttpClientFactory</span> <span class="n">httpClientFactory</span> <span class="p">=</span> <span class="nf">GetHttpClientFactory</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">baseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://localhost:5030/"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">requestUrl</span> <span class="p">=</span> <span class="s">"WeatherForecast"</span><span class="p">;</span>

<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">httpClientFactory</span><span class="p">.</span><span class="nf">CreateClient</span><span class="p">(</span><span class="s">"SampleHttpClient"</span><span class="p">))</span>
<span class="p">{</span>
   <span class="c1">// 設定Time Out</span>
   <span class="n">client</span><span class="p">.</span><span class="n">Timeout</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
   <span class="n">client</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="n">baseAddress</span><span class="p">;</span>

   <span class="k">try</span>
   <span class="p">{</span>
      <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">requestUrl</span><span class="p">);</span>
      <span class="kt">var</span> <span class="n">contentStr</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>

      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">contentStr</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">TaskCanceledException</span> <span class="n">ex</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"TaskCanceledException"</span><span class="p">);</span>
      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Call Second Api"</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">postContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringContent</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">response2</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">requestUrl</span><span class="p">}</span><span class="s">?name=jyu"</span><span class="p">,</span> <span class="n">postContent</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">contentStr2</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response2</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>

      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">contentStr2</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Exception"</span><span class="p">);</span>
      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">CreateClient</code>可以使用命名模式，參數可帶入自訂命名，如果有在Service註冊時，設定指定命名HttpClient配置實體，可以在實際使用時，依據指定命名取得對應已配置好設定實體，如果未有對應則會建立新實體。</p>

<p>詳細可參考 <a href="https://docs.microsoft.com/zh-tw/aspnet/core/fundamentals/http-requests?view=aspnetcore-6.0#named-clients">具名用戶端</a></p>

<p>上述Http請求行為如下</p>
<ul>
  <li>設定逾時秒數。</li>
  <li>設定Base Address。
    <ul>
      <li>所有呼叫API都在此基底位址下。</li>
    </ul>
  </li>
  <li>呼叫第一支API，當逾時發生時，拋出<code class="language-plaintext highlighter-rouge">TaskCanceledException</code>。</li>
  <li>try-catch攔截到<code class="language-plaintext highlighter-rouge">TaskCanceledException</code>發生，進行呼叫第二支API。</li>
</ul>

<hr />

<h2 id="範例web-api">範例Web API</h2>

<p>使用預設建置<code class="language-plaintext highlighter-rouge">WeatherForecast</code> Controller模板，原始預設產生<code class="language-plaintext highlighter-rouge">GetWeatherForecast</code> API調整如下。</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"GetWeatherForecast"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">WeatherForecast</span><span class="p">&gt;&gt;</span> <span class="nf">Get</span><span class="p">()</span>
<span class="p">{</span>
   <span class="c1">// 加入此行當收到Request就先等待10秒再進行後續</span>
   <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">10000</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="n">index</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">WeatherForecast</span>
   <span class="p">{</span>
      <span class="n">Date</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddDays</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
      <span class="n">TemperatureC</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Next</span><span class="p">(-</span><span class="m">20</span><span class="p">,</span> <span class="m">55</span><span class="p">),</span>
      <span class="n">Summary</span> <span class="p">=</span> <span class="n">Summaries</span><span class="p">[</span><span class="n">Random</span><span class="p">.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">Summaries</span><span class="p">.</span><span class="n">Length</span><span class="p">)]</span>
   <span class="p">})</span>
   <span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在同樣Controller新增第二支API</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">HttpPost</span><span class="p">(</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"PostSecondApi"</span><span class="p">)]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Post</span><span class="p">(</span>
   <span class="p">[</span><span class="n">FromQuery</span><span class="p">]</span> <span class="kt">string</span> <span class="n">name</span>
<span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Hello </span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s"> !!!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h4 id="相關參考">相關參考</h4>

<ol>
  <li><a href="https://github.com/s123600g/jyu.demo.HttpClientFactory">筆記Demo程式碼 - jyu.demo.HttpClientFactory</a></li>
  <li><a href="https://docs.microsoft.com/zh-tw/aspnet/core/fundamentals/http-requests?view=aspnetcore-3.1#consumption-patterns">在 ASP.NET Core 中使用 IHttpClientFactory 發出 HTTP 要求</a></li>
  <li><a href="https://docs.microsoft.com/zh-tw/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests">使用 HttpClientFactory 實作復原 HTTP 要求</a></li>
  <li><a href="https://iter01.com/604146.html">把HttpClient換成IHttpClientFactory之後，放心多了</a></li>
  <li><a href="https://tiaohsun.netlify.app/posts/%E5%B9%BE%E7%A8%AE%E4%BD%BF%E7%94%A8ihttpclientfactory%E6%96%B9%E6%B3%95/">幾種使用IHttpClientFactory方法</a></li>
</ol>



    <script src="https://utteranc.es/client.js" repo="s123600g/s123600g.github.io"
      issue-term="title" theme="boxy-light"
      label="Article" crossorigin="anonymous" async></script>
  </main>
</body>

<div class="container">
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
        <div class="col-md-4 d-flex align-items-center">
            <a href="/" class="mb-3 me-2 mb-md-0 text-muted text-decoration-none lh-1">
                <svg class="bi" width="30" height="24">
                    <use xlink:href="#bootstrap"></use>
                </svg>
            </a>
            <span class="text-muted">© 2023 JYUN YU LI. All rights reserved.</span>
        </div>

        <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
            <li class="ms-3">
                <a class="text-muted" href="https://github.com/s123600g" target="_blank">
                    <i class="fab fa-github fs-3"></i>
                </a>
            </li>

            <li class="ms-3">
                <a class="text-muted" href="mailto://s123600g@gmail.com">
                    <i class="fas fa-envelope fs-3"></i>
                </a>
            </li>
        </ul>
    </footer>
</div>

</html>